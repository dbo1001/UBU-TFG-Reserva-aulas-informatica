{% extends "navBar.html" %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<link href="/static/css/bootstrap.min.css" rel="stylesheet">
<link href="/static/css/navBar.css" rel="stylesheet">
<link href="/static/css/buttons.css" rel="stylesheet">
{% block title %} 
<title>Tabla de eventos</title>   
<div class="jumbotron" style="margin-bottom: 0;padding:2rem 2rem;">
  <div class="container">
    <div class="row">
      <div class="col-lg-12 col-lg-offset-1">
        <h1 style="margin-top: 0; text-align: center;">Tabla de eventos</h1>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}


<nav class="navbar fixed-bottom navbar-expand-sm navbar-dark bg-dark"></nav>

<form name="modEvent" id="modEvent" class="border" method="POST" style="display:none;padding:5px" >

{{ modEventForm.csrf_token }}
  <div class="row" style="width=100%;" >
    <div class="col-3">{{ modEventForm.tema.label }}
    {{ modEventForm.tema }}</div>
    <div class="col-3">{{ modEventForm.user.label }}
    {{ modEventForm.user }}</div>
    <div class="col-3">{{ modEventForm.fechaIni.label }}
    {{ modEventForm.fechaIni }}</div>
    <div class="col-3">{{ modEventForm.fechaFin.label }}
    {{ modEventForm.fechaFin }}</div>
    <meta name="csrf-token" content="{{ csrf_token() }}">
  </div>
  <div class="col-3" style="padding:5px;"><a type='button' id ='guardarAula' onclick=modEventForm.submit()>{{ modEventForm.submit }}</a></div>

</form>

<!-- Si el diccionario de eventos esta vacio no se muestra nada -->
  
    <table id="tablaEventos" class="table table-striped table-bordered table-sm" cellspacing="40" overflow="auto">
      <!-- <script type="text/javascript" src="{{ url_for('static', filename='events.js') }}"></script> -->
      <thead>
      <tr>
        <th>Nº reserva</th>
        <th>Aula</th>
        <th>Tema</th>
        <th>Usuario</th>
        <th>Fecha inicio</th>
        <th>Fecha fin</th>
        {% if listaPropietarios %}
        <th>Acciones</th>
        {% endif %}
      </tr>
    </thead>
    <input id="buscar" type="text" class="form-control" placeholder="Escriba algo para filtrar" style="border-block-color: lightblue;"/>
    {% if dictEvents %}
    <tbody>
      {% set contador = 0%}
      {% for event in dictEvents %}
        {% if event[4] < fechaActual %}
          <tr row_id={{contador + loop.index }}>
            <td style="color : red"><div class="row_data" col_name="n_reserva">{{ event[0] }}</div></td>
            <td style="color : red"><div class="row_data" col_name="aula">{{ event[1] }}</div></td>
            <td style="color : red"><div class="row_data" col_name="tema">{{ event[2] }}</div></td>
            <td style="color : red"><div class="row_data" col_name="user">{{ event[7] }}</div> </td>
            <td style="color : red"><div class="row_data" col_name="fechaI">{{ event[4] }}</div> </td>
            <td style="color : red"><div class="row_data" col_name="fechaF">{{ event[5] }} </div></td>
            {% if event[3] == session['user_email'] or session['user_email'] in ADMIN_USERS %}
                <td>
               </td>
            {% endif %} 
          </tr>
        {% else %}
          <tr row_id={{contador + loop.index }}>
            <td style="color : red"><div class="row_data" col_name="n_reserva">{{ event[0] }}</div></td>
            <td style="color : green"><div class="row_data" col_name="aula">{{ event[1] }}</div></td>
            <td style="color : green"><div class="row_data" col_name="tema">{{ event[2] }}</div></td>
            <td style="color : green"><div class="row_data" col_name="user">{{ event[7] }}</div></td>
            <td style="color : green"><div class="row_data" col_name="fechaI">{{ event[4] }}</div></td>
            <td style="color : green"><div class="row_data" col_name="fechaF">{{ event[5] }}</div></td>
            {% if session['user_email'] == propietario[0][0] or session['user_email'] in ADMIN_USERS %}
              <td>
                <button class="editbtn" id="editBtn" style="display:flex;" row_id={{contador + loop.index }}>Modificar</button>
                <button class="deletebtn" id="eliminarBtn" style="display:flex;" row_id={{contador + loop.index }}>Borrar</button>
              </td>
            {% endif %}
          </tr>
        {% endif %}
      {% endfor %}
    </tbody>
    {% endif %}
    </table>

<div style="margin-bottom:50px;">
  <b>Leyenda</b><br>
  <svg width="15" height="15">
    <rect x="5" y="2" rx="2" ry="2" width="10" height="10"
    style="fill:red;" />
  </svg>   Eventos pasados<br>
  <svg width="15" height="15">
    <rect x="5" y="2" rx="2" ry="2" width="10" height="10"
    style="fill:green;" />
  </svg>   Eventos futuros<br>
</div>


{% endblock %}

<script>
document.getElementById("buscar").onkeyup = function() {
      var buscar_= this.value.toLowerCase() ;
      document.querySelectorAll('.table tbody tr').forEach(function(e){
        var encontro_ =false;
        e.querySelectorAll('td').forEach(function(e){
          if (e.innerHTML.toLowerCase().indexOf(buscar_)>=0){
            encontro_=true;
          }
        }); 
        if (encontro_){
          e.style.display = '';
        }else{
          e.style.display = 'none';
        }
      });              
}


 $('.editbtn').click(function() {
  console.log("Primera linea");
  item = $(this).closest("tr").text();
  console.log($(this).closest("tr"));
  var currentRow=$(this).closest("tr"); 
  console.log(currentRow);
  //Habra que enviar el nombreAula y las fechas para saber que evento actualizar
  var nombreAula=currentRow.find("td:eq(1)").text(); // get current row 1st TD value
  var tema = currentRow.find("td:eq(2)").text();
  var user = currentRow.find("td:eq(3)").text();
  var fechaInicio=currentRow.find("td:eq(4)").text(); 
  var fechaFin=currentRow.find("td:eq(5)").text(); 

  document.getElementById("tema").value = tema;
  document.getElementById("user").value = user;
  document.getElementById("fechaIni").value = fechaInicio;
  document.getElementById("fechaFin").value = fechaFin;

  var csrftoken = "{{ csrf_token() }}";
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
          if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
              xhr.setRequestHeader("X-CSRFToken", csrftoken)
          }
      }
    })
    $.ajax({
      type: "POST",
      url: "/modificarEvento",
      dataType: 'json',
      contentType: 'application/json; charset=utf-8',
      data: JSON.stringify({aula: nombreAula, fechaIni: fechaInicio, fechaF: fechaFin}),
      success: function(response) {
        console.log("Se consigue ");
        $('#modEvent').css('display', 'block');
      }
    });
});
$('.deletebtn').click(function() {
  item = $(this).closest("tr").text();
  console.log($(this).closest("tr"));
  var currentRow=$(this).closest("tr"); 
  console.log(currentRow);
  //Hay que enviar el nombreAula y las fechas para saber que evento actualizar
  var idEvento = currentRow.find("td:eq(0)").text();
  var nombreAula=currentRow.find("td:eq(1)").text(); // get current row 1st TD value
  var tema = currentRow.find("td:eq(2)").text();
  var user = currentRow.find("td:eq(3)").text();
  var fechaInicio=currentRow.find("td:eq(4)").text(); 
  var fechaFin=currentRow.find("td:eq(5)").text(); 
  var opcion = confirm("¿Esta seguro que quiere borrar el evento "+tema+" ?");
  if (opcion == true) {
    var csrftoken = "{{ csrf_token() }}";
      $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken)
            }
        }
      })
      $.ajax({
        type: "POST",
        url: "/borrarEvento",
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify({aula: nombreAula, fechaIni: fechaInicio, fechaF: fechaFin,idEvento:idEvento}),
        success: function(response) {
          console.log(response);
          if(response['success']==true){
          window.alert("Se ha borrado correctamente el evento");
          window.location = window.location.href;          
          }else{
            window.alert("No se borra");
          }
        }
      });
  }

});

</script>
<html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<link href="/static/css/bootstrap.min.css" rel="stylesheet">
<link href="/static/css/navBar.css" rel="stylesheet">
<link href="/static/css/buttons.css" rel="stylesheet">
{% block title%}
<div class="jumbotron" style="margin-bottom: 0;">
    <div class="container">
      <div class="row">
        <div class="col-lg-10 col-lg-offset-1">
          <h1 style="margin-top: 0; text-align: center;">Información sobre aulas</h1>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block content %}

<body style="padding-top: 0">

  <nav class="navbar navbar-expand-lg navbar-light bg-light" id="navBar">
    <!-- <div class="collapse navbar-collapse" id="navbarSupportedContent"> -->
      <ul class="navbar-nav mr-auto">
        <li class="homeImg">
          <a class="navbar-brand" href="{{ url_for('inicio') }}">
            <img src="/static/img/home.jpg" width="30" height="30" alt="">
          </a>
        </li>
        <li class="nav-item"><a type="button" class="nav-link" onclick="window.location.href='{{ url_for('events') }}'">Consultar ocupación de aulas</a></li>

        <li class="nav-item">
          {% if session['user_email'] in session['listaUsuariosPropietarios'] or session['user_email'] in ADMIN_USERS %}   
            <a type="button" class="nav-link" onclick="window.location.href='{{ url_for('reservar') }}'">Realizar reserva</a>
          {% else %}
            <a type="button" class="nav-link disabled" onclick="window.location.href='{{ url_for('reservar') }}'">Realizar reserva</a>
          {% endif %}
        </li>
          
        <li>
          <a type="button" class="nav-link" onclick="window.location.href='{{ url_for('verAulas') }}'">Ver/Modificar aulas</a>          
        </li>

        <li>
          {% if session['user_email'] in ADMIN_USERS %}        
            <a type="button" class="nav-link" onclick="window.location.href='{{ url_for('anadirAulas') }}'">Añadir aulas</a>
          {% else %}
            <a type="button" class="nav-link disabled" onclick="window.location.href='{{ url_for('anadirAulas') }}'">Añadir aulas</a>
          {% endif %}
        </li>
      </ul>
    <!-- </div> -->
  </nav>
    <div class="container">


      <form name="seeAulas" id="seeAulas" method="POST">
          {{ form.csrf_token }}
          <div>{{ form.select.label }}</div>
          <div style="padding-bottom: 5px;">{{ form.select }}</div>
          <meta name="csrf-token" content="{{ csrf_token() }}">
          <button type='button' id ='verAulas' class="btn btn-link" onclick=form.submit()>Ver aulas</button>
          
      </form>


      <form name="modAulas" id="modAulas" class="border" method="POST" style="display:none;padding:5px" >
        {{ form2.csrf_token }}
        <div class="row" >
          <div class="col-3">{{ form2.nombreAula.label }}
          {{ form2.nombreAula }}</div>
          <div class="col-3">{{ form2.edificio.label }}
          {{ form2.edificio }}</div>
          <div class="col-3">{{ form2.tipo.label }}
          {{ form2.tipo }}</div>
          <div class="col-3">{{ form2.capacidad.label }}
          {{ form2.capacidad }}</div>
          <div class="col-3">{{ form2.n_ordenadores.label }}
          {{ form2.n_ordenadores }}</div>
          <div class="col-3">{{ form2.propietario.label }}
          {{ form2.propietario }}</div>
          <meta name="csrf-token" content="{{ csrf_token() }}">
        </div>
        <div class="col-3" style="padding:5px;"><a type='button' id ='guardarAula' onclick=form2.submit()>{{ form2.submit }}</a></div>

      </form>

      {% if cambio %}
      <div class="alert alert-success col-md-6" role="alert" >
        <h4 class="alert-heading">Aula modificada</h4>
        <p>Los cambios se han actualizado correctamente.</p>
      </div>
      {% endif %}

      <!-- Si se elige un edificio de que mostrar aulas-->
      {% if aulas %}
        <table id="tablaAulas" class="table table-striped table-bordered table-sm" cellspacing="40" overflow="auto">
            <thead>
            <tr>
              <th>Nombre</th>
              <th>Edificio</th>
              <th>Tipo</th>
              <th>Capacidad</th>
              <th>Nº ordenadores</th>
              <th>Propietario</th>
            </tr>
          </thead>

          <tbody>
            {% set contador = 0%}
            {% for aula in aulas %}
                <tr row_id={{contador + loop.index }}>
                  <td><div class="row_data" col_name="nombre" id="nombreFila">{{ aula[0] }}</div></td>
                  <td><div class="row_data" col_name="edificio">{{ aula[1] }}</div></td>
                  <td><div class="row_data" col_name="tipo">{{ aula[2] }}</div> </td>
                  <td><div class="row_data" col_name="capacidad">{{ aula[3] }} </div></td>
                  <td><div class="row_data" col_name="n_ord">{{ aula[5] }}</div> </td>
                  <td><div class="row_data" col_name="propietario">{{ aula[4] }}</div> </td>
                  {% if session['user_email'] in ADMIN_USERS %}
                  <td><button class="editbtn" id="editarBtn" style="display:flex;" row_id={{contador + loop.index }}>Editar</button>
                    <button class="deletebtn" id="borrarBtn" style="display:flex;" row_id={{contador + loop.index }}>Borrar</button>
                  </td>
                  {% endif %}
                </tr>
            {% endfor %}
          </tbody>

        </table>
    </div>
    {% endif %}

{% if cambioProp == True %}
  <div class="alert alert-success col-md-6" role="alert" id="createdMsg" >
    <h4 class="alert-heading">Aula modificada</h4>
    <p>Se ha modificado el propietario, porfavor asigne los permisos necesarios del  aula al nuevo propietario {{ prop }}</p>
  </div>
{% endif %}
<div class="alert alert-success col-md-6" role="alert" id="aulaElim" style="display:none">
  <h4 class="alert-heading">Aula eliminada</h4>
  <p> El aula se ha eliminado correctamente.</p>
</div>

</body>
{% endblock content%}
<script>
//Funcion boton editar
 $('.editbtn').click(function() {
 item = $(this).closest("tr").text();
  //console.log(item);
  console.log($(this).closest("tr"));
  var currentRow=$(this).closest("tr"); 
         
  //Habra que enviar el nombreAula inicial para saber que aula actualizar
  var col1=currentRow.find("td:eq(0)").text(); // get current row 1st TD value
  var col2=currentRow.find("td:eq(1)").text(); 
  var col3=currentRow.find("td:eq(2)").text();
  var col4=currentRow.find("td:eq(3)").text(); 
  var col5=currentRow.find("td:eq(4)").text(); 
  var col6=currentRow.find("td:eq(5)").text(); 
  var data=col1+"\n"+col2+"\n"+col3+"\n"+col4+"\n"+col5+"\n"+col6;
 
  document.getElementById("nombreAula").value = col1;
  console.log(col2);
  document.getElementById("edificio").mySelect = col2;
  document.getElementById("tipo").value = col3;  
  document.getElementById("capacidad").value = col4;
  document.getElementById("n_ordenadores").value = col5;
  document.getElementById("propietario").value = col6;



  var csrftoken = $('meta[name=csrf-token]').attr('content')
        $.ajaxSetup({
          beforeSend: function(xhr, settings) {
              if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                  xhr.setRequestHeader("X-CSRFToken", csrftoken)
              }
          }
        })

      $.ajax({
          type: "POST",
          url: "/verAulas",
          dataType: 'json',
          contentType: 'application/json; charset=utf-8',
          data: JSON.stringify({aula: col1, prop: col6}),
          success: function(response) {
             $('#modAulas').css('display', 'block');
          }
      });
  
  });

//Funcion boton borrar
$('.deletebtn').click(function() {
    var fila = $(this).closest('tr');
    var id_fila = fila.attr('row_id');

    var aulaName = fila.find("td:eq(0)").text();
    var mensaje;
    var opcion = confirm("¿Esta seguro que quiere borrar el aula "+aulaName+" ?");
    if (opcion == true) {
      console.log("Aceptado")
      var csrftoken = $('meta[name=csrf-token]').attr('content')
      $.ajaxSetup({
          beforeSend: function(xhr, settings) {
              if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                  xhr.setRequestHeader("X-CSRFToken", csrftoken)
              }
          }
        })
      $.ajax({
          type: "POST",
          url: "/eliminarAula",
          dataType: 'json',
          contentType: 'application/json; charset=utf-8',
          data: JSON.stringify({aula: aulaName}),
          success: function(response) {
             $('#aulaElim').css('display', 'block');
          }
      });
	  } else {
	    mensaje = "Has clickado Cancelar";
	  }

  });
/*
//Funcion boton guardar
  $('#guardarBtn').click(function() {
    var fila = $(this).closest('tr');
    var id_fila = fila.attr('row_id');
    $('#guardarBtn').css('display', 'none');
    $('#cancelarBtn').css('display', 'none');
    $('#editarBtn').css('display', 'block');   

    //Quitar el editable de la fila
    fila.find('.row_data').attr('contenteditable','false').css("background-color", "")

    //Guardar los datos en el template
    var arr = [];
    console.log("HOLA");
    fila.find('.row_data').each(function(index,val){
      var col_name = $(this).attr('col_name');
      var col_var = $(this).html();
      arr.push((col_name,col_var));
    });   
    alert("suepramos");
    //Enviar los cambios al views
    
    var csrftoken = $('meta[name=csrf-token]').attr('content')
      $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken)
            }
        }
      })

    $.ajax({
        type: "POST",
        url: "/modificarAula",
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(arr),
        error: function(response){
          console.log("Llego al error");
          console.log(response);
          alert(response.responseText);
        }
    });

  }); */
</script>


</html>